# üîç JGGL CRM ‚Äî Full-Text Search (–ü–æ–∏—Å–∫ –ø–æ –ª–∏–¥–∞–º)

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –ø–æ–∏—Å–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **PostgreSQL Full-Text Search (FTS)** –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ –ª–∏–¥–∞–º (deals).
–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å —Å–¥–µ–ª–∫–∏ –∑–∞ 1-2 —Å–µ–∫—É–Ω–¥—ã –¥–∞–∂–µ –ø—Ä–∏ 10k+ –∑–∞–ø–∏—Å–µ–π.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         User Query                              ‚îÇ
‚îÇ                    "–ò–≤–∞–Ω —Ü–µ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞"                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Query Classifier                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ isExactIdSearch ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ –¢–æ—á–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ ID/PSID         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ (—Ü–∏—Ñ—Ä—ã/–¥–ª–∏–Ω–Ω—ã–π  ‚îÇ    ‚îÇ WHERE id = ? OR psid = ?        ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  —Ç–æ–∫–µ–Ω)         ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                            ‚îÇ
‚îÇ           ‚îÇ                                                     ‚îÇ
‚îÇ           ‚îÇ –∏–Ω–∞—á–µ                                               ‚îÇ
‚îÇ           ‚ñº                                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ              Full-Text Search (FTS)                      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  websearch_to_tsquery('russian', '–ò–≤–∞–Ω:* & —Ü–µ–Ω–∞:* ...')  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  + ts_rank –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏               ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    GIN Index Scan                               ‚îÇ
‚îÇ                 deals_search_vector_gin_idx                     ‚îÇ
‚îÇ                     (O(log n) lookup)                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è

| –ü–æ–ª–µ | –í–µ—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `contact.name` | A (–≤—ã—Å—à–∏–π) | –ò–º—è –∫–æ–Ω—Ç–∞–∫—Ç–∞ |
| `contact.first_name` | A | –ò–º—è |
| `contact.last_name` | A | –§–∞–º–∏–ª–∏—è |
| `deal.ai_summary` | B | AI-–∞–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ |
| `deal.ai_intent` | B | –ù–∞–º–µ—Ä–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ (–∏–∑ AI) |
| `deal.comment` | C | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä–∞ |
| `deal.last_message_text` | C | –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ |
| `contact.psid` | D (–Ω–∏–∑—à–∏–π) | Meta PSID |
| `deal.status` | D | –°—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏ |

### –í–µ—Å–∞ (A > B > C > D)

PostgreSQL FTS –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞–∑–Ω–∞—á–∞—Ç—å –≤–µ—Å–∞ –ø–æ–ª—è–º:
- **A**: –°–∞–º—ã–π –≤–∞–∂–Ω—ã–π ‚Äî –∏–º—è –∫–æ–Ω—Ç–∞–∫—Ç–∞. –ü–æ–∏—Å–∫ "–ò–≤–∞–Ω" —Å–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥—ë—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã —Å –∏–º–µ–Ω–µ–º –ò–≤–∞–Ω.
- **B**: –°—Ä–µ–¥–Ω–∏–π ‚Äî AI –¥–∞–Ω–Ω—ã–µ, —Ö–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω—ã.
- **C**: –û–±—ã—á–Ω—ã–π ‚Äî –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ —Å–æ–æ–±—â–µ–Ω–∏—è, –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —à—É–º.
- **D**: –ù–∏–∑–∫–∏–π ‚Äî —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è (psid, status).

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –ú–∏–≥—Ä–∞—Ü–∏—è

```php
// database/migrations/2026_01_21_220000_add_search_vector_to_deals.php

// 1. –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–æ–Ω–∫—É tsvector
DB::statement('ALTER TABLE deals ADD COLUMN search_vector tsvector');

// 2. –°–æ–∑–¥–∞—ë—Ç GIN –∏–Ω–¥–µ–∫—Å
DB::statement('CREATE INDEX deals_search_vector_gin_idx ON deals USING GIN (search_vector)');

// 3. –°–æ–∑–¥–∞—ë—Ç —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
CREATE TRIGGER deals_search_vector_trigger
BEFORE INSERT OR UPDATE ON deals
FOR EACH ROW EXECUTE FUNCTION deals_search_vector_update();
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–∞

```sql
-- –†–∞–∑–º–µ—Ä –∏–Ω–¥–µ–∫—Å–∞
SELECT pg_size_pretty(pg_relation_size('deals_search_vector_gin_idx'));

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
SELECT * FROM pg_stat_user_indexes 
WHERE indexrelname = 'deals_search_vector_gin_idx';

-- –ü—Ä–∏–º–µ—Ä –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
EXPLAIN ANALYZE
SELECT * FROM deals 
WHERE search_vector @@ to_tsquery('russian', '—Ü–µ–Ω–∞:* & –¥–æ—Å—Ç–∞–≤–∫–∞:*');
```

## –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è

### –ö–æ–º–∞–Ω–¥–∞ Artisan

```bash
# –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤—Å–µ—Ö deals
php artisan crm:reindex-leads

# –° –∫–∞—Å—Ç–æ–º–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º chunk (–¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏)
php artisan crm:reindex-leads --chunk=500

# Dry run ‚Äî —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
php artisan crm:reindex-leads --dry-run
```

### –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è

1. **–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏** ‚Äî –ø—Ä–∏ –ø–µ—Ä–≤–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
2. **–ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö** ‚Äî –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–∞–ª–∏ deals –Ω–∞–ø—Ä—è–º—É—é –≤ –ë–î
3. **–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤–µ—Å–æ–≤** ‚Äî –µ—Å–ª–∏ –º–µ–Ω—è–ª–∏ –ª–æ–≥–∏–∫—É –≤ —Ç—Ä–∏–≥–≥–µ—Ä–µ
4. **–ü–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ backup** ‚Äî –µ—Å–ª–∏ backup –Ω–µ –≤–∫–ª—é—á–∞–ª –∏–Ω–¥–µ–∫—Å—ã

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

- **–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ Deal** ‚Üí —Ç—Ä–∏–≥–≥–µ—Ä –ë–î –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç `search_vector`
- **–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ Contact** ‚Üí Observer (`ContactObserver`) –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ deals

## API

### Endpoint

```
GET /deals?search=...&mine=1&status=New&sort=score&page=1
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|----------|
| `search` | string | –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å |
| `status` | string | `New`, `In Progress`, `Closed` |
| `manager_id` | int | ID –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞) |
| `sla_overdue` | bool | –¢–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ SLA |
| `priority` | bool | –¢–æ–ª—å–∫–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ |
| `unassigned` | bool | –¢–æ–ª—å–∫–æ –±–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ |
| `unviewed` | bool | –¢–æ–ª—å–∫–æ –Ω–µ–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ |
| `hot_leads` | bool | –¢–æ–ª—å–∫–æ AI Score > 80 |
| `sort` | string | `smart`, `sla`, `priority`, `score`, `updated`, `created` |
| `page` | int | –ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã (15 –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É) |

### –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

```bash
# –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏
GET /deals?search=–ò–≤–∞–Ω

# –¢–æ—á–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ PSID
GET /deals?search=123456789012345678

# –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–∏—Å–∫ + —Ñ–∏–ª—å—Ç—Ä
GET /deals?search=–¥–æ—Å—Ç–∞–≤–∫–∞&status=New&priority=1

# –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ AI Score
GET /deals?sort=score
```

## UI

### Desktop

- –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ —Å debounce 350ms
- Quick filter —á–∏–ø—ã (SLA, Priority, Hot Leads, etc.)
- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –≤ dropdown
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫

### Mobile

- Sticky search bar (—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ)
- –ö–Ω–æ–ø–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Å badge –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
- Bottom sheet –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
- Touch targets ‚â• 44px

### –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤

–ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ –∫–∞—Ä—Ç–æ—á–∫—É —Å–¥–µ–ª–∫–∏ –∏ –≤–æ–∑–≤—Ä–∞—Ç–µ ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ URL query params.

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ú–µ—Ç—Ä–∏–∫–∏

| –û–ø–µ—Ä–∞—Ü–∏—è | –í—Ä–µ–º—è (10k deals) |
|----------|-------------------|
| FTS –ø–æ–∏—Å–∫ (indexed) | < 50ms |
| ILIKE –ø–æ–∏—Å–∫ (–±–µ–∑ –∏–Ω–¥–µ–∫—Å–∞) | 500-2000ms |
| –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è | ~1 –º–∏–Ω |

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ILIKE** –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ ‚Äî —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (< 3 —Å–∏–º–≤–æ–ª–æ–≤)
2. **–†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–∞–∑–º–µ—Ä –∏–Ω–¥–µ–∫—Å–∞** ‚Äî –µ—Å–ª–∏ > 10% –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã, –≤–æ–∑–º–æ–∂–Ω–æ —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å slow queries** ‚Äî –µ—Å–ª–∏ FTS –∑–∞–ø—Ä–æ—Å—ã > 100ms, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `EXPLAIN ANALYZE`

## Troubleshooting

### –ü–æ–∏—Å–∫ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `search_vector` –∑–∞–ø–æ–ª–Ω–µ–Ω:
   ```sql
   SELECT id, search_vector IS NOT NULL FROM deals LIMIT 10;
   ```

2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é:
   ```bash
   php artisan crm:reindex-leads
   ```

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —è–∑—ã–∫ —Å–ª–æ–≤–∞—Ä—è:
   ```sql
   SELECT to_tsvector('russian', '–¢–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç');
   -- –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: '—Ç–µ—Å—Ç–æ–≤':1 '—Ç–µ–∫—Å—Ç':2
   ```

### –ú–µ–¥–ª–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞:
   ```sql
   EXPLAIN ANALYZE SELECT * FROM deals 
   WHERE search_vector @@ to_tsquery('russian', '—Ü–µ–Ω–∞:*');
   ```
   –î–æ–ª–∂–µ–Ω –±—ã—Ç—å "Bitmap Index Scan" –∏–ª–∏ "Index Scan", –ù–ï "Seq Scan".

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞:
   ```sql
   SELECT pg_size_pretty(pg_relation_size('deals_search_vector_gin_idx'));
   REINDEX INDEX deals_search_vector_gin_idx;
   ```

### –¢—Ä–∏–≥–≥–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞:
   ```sql
   SELECT * FROM pg_trigger WHERE tgname = 'deals_search_vector_trigger';
   ```

2. –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä (–æ—Ç–∫–∞—Ç–∏—Ç—å –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ):
   ```bash
   php artisan migrate:rollback --step=1
   php artisan migrate
   ```

## –§–∞–π–ª—ã

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `database/migrations/2026_01_21_220000_add_search_vector_to_deals.php` | –ú–∏–≥—Ä–∞—Ü–∏—è —Å tsvector, GIN –∏–Ω–¥–µ–∫—Å, —Ç—Ä–∏–≥–≥–µ—Ä |
| `app/Console/Commands/ReindexLeads.php` | Artisan –∫–æ–º–∞–Ω–¥–∞ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ |
| `app/Observers/ContactObserver.php` | Observer –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ Contact |
| `app/Http/Controllers/DealController.php` | –ü–æ–∏—Å–∫–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ (–º–µ—Ç–æ–¥—ã `isExactIdSearch`, `buildSearchQuery`) |
| `resources/js/Pages/Dashboard.jsx` | UI —Å debounce –ø–æ–∏—Å–∫–æ–º |
| `tests/Feature/SearchTest.php` | –¢–µ—Å—Ç—ã –ø–æ–∏—Å–∫–∞ |
