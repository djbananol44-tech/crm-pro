<?php

use App\Http\Controllers\MetaWebhookController;
use App\Http\Controllers\TelegramController;
use App\Http\Controllers\TestWebhookController;
use Illuminate\Support\Facades\Route;

/*
|--------------------------------------------------------------------------
| API Routes
|--------------------------------------------------------------------------
|
| ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ Ð´Ð»Ñ API. Ð­Ñ‚Ð¸ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÑŽÑ‚ÑÑ RouteServiceProvider
| Ð¸ Ð½Ð°Ñ…Ð¾Ð´ÑÑ‚ÑÑ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ðµ middleware "api".
|
| Rate Limits:
|   - webhook: 300/min (Meta bursts)
|   - api: 60/min (ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ð¹)
|   - test: 10/min (Ð·Ð°Ñ‰Ð¸Ñ‚Ð°)
|
*/

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ”— Webhooks (Meta, Telegram)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Rate Limit: 300/min â€” Ð²Ñ‹ÑÐ¾ÐºÐ¸Ð¹ Ð»Ð¸Ð¼Ð¸Ñ‚ Ð´Ð»Ñ Meta bursts
// CSRF: Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ñ‹
//
Route::prefix('webhooks')
    ->middleware('throttle:webhook')
    ->group(function () {

        // Meta: Ð’ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ (GET) â€” Ð±ÐµÐ· Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸, Ð±ÐµÐ· rate limit (Ð¾Ð´Ð¸Ð½ Ð·Ð°Ð¿Ñ€Ð¾Ñ)
        Route::get('/meta', [MetaWebhookController::class, 'verify'])
            ->withoutMiddleware('throttle:webhook')
            ->name('webhooks.meta.verify');

        // Meta: ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹ (POST) â€” Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑŒÑŽ + rate limit
        Route::post('/meta', [MetaWebhookController::class, 'handle'])
            ->middleware('meta.signature')
            ->name('webhooks.meta.handle');

        // Telegram: Webhook
        Route::post('/telegram', [TelegramController::class, 'webhook'])
            ->name('webhooks.telegram');
    });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ¥ Health Check (Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹, Ð±ÐµÐ· auth)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Route::get('/health', [TestWebhookController::class, 'healthCheck'])
    ->name('api.health');

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ§ª Test Endpoints (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Rate Limit: 10/min â€” Ð·Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ Ð·Ð»Ð¾ÑƒÐ¿Ð¾Ñ‚Ñ€ÐµÐ±Ð»ÐµÐ½Ð¸Ð¹
//
Route::prefix('test')
    ->middleware('throttle:test')
    ->group(function () {

        // Ð­Ð¼ÑƒÐ»ÑÑ†Ð¸Ñ Ð²Ñ…Ð¾Ð´ÑÑ‰ÐµÐ³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ñ‚ Meta
        Route::post('/incoming-meta', [TestWebhookController::class, 'simulateMetaIncoming'])
            ->name('test.incoming-meta');

        // Health check (Ð´ÑƒÐ±Ð»Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸)
        Route::get('/health', [TestWebhookController::class, 'healthCheck'])
            ->withoutMiddleware('throttle:test')
            ->name('test.health');
    });
