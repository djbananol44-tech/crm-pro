#!/bin/sh
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ü§ñ Telegram Bot Worker Entrypoint
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º:
# - –ï—Å–ª–∏ —Ä–µ–∂–∏–º = webhook ‚Äî worker –Ω–µ –Ω—É–∂–µ–Ω, –≤—ã—Ö–æ–¥–∏–º
# - –ï—Å–ª–∏ —Ä–µ–∂–∏–º = polling ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º worker
#
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

set -e

echo "ü§ñ Telegram Bot Worker Entrypoint"

# –ñ–¥—ë–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
MODE=$(php artisan tinker --execute="echo \App\Models\Setting::get('telegram_mode', 'polling');" 2>/dev/null || echo "polling")

echo "üìç –†–µ–∂–∏–º Telegram: ${MODE}"

if [ "$MODE" = "webhook" ]; then
    echo "üîó –†–µ–∂–∏–º = webhook, bot_worker –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
    echo "   –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ /api/webhooks/telegram"
    echo "   –î–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ polling: php artisan telegram:setup --mode=polling"
    
    # –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π sleep —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –ø–∞–¥–∞–ª
    # Docker restart policy –Ω–µ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å
    echo "üí§ –°–ø–∏–º –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ (webhook —Ä–µ–∂–∏–º)..."
    while true; do
        sleep 3600
    done
else
    echo "üîÑ –†–µ–∂–∏–º = polling, –∑–∞–ø—É—Å–∫–∞–µ–º worker..."
    exec php artisan telegram:worker --timeout=60
fi
